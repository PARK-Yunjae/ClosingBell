"""
상수 정의 모듈

책임:
- 점수 산출 관련 상수
- 기술 지표 계산 파라미터
- 시스템 상수
"""

from enum import Enum
from dataclasses import dataclass

# ============================================================
# 기술 지표 계산 상수
# ============================================================

# CCI 계산
CCI_PERIOD = 14  # CCI 계산 기간

# 이동평균선
MA20_PERIOD = 20  # 20일 이동평균선

# 기울기 계산 기간
CCI_SLOPE_PERIOD = 5   # CCI 기울기 계산 기간 (최근 5일)
MA20_SLOPE_PERIOD = 7  # MA20 기울기 계산 기간 (최근 7일)


# ============================================================
# 점수 산출 상수
# ============================================================

# 점수 범위
SCORE_MAX = 10.0
SCORE_MIN = 0.0

# 가중치 범위
WEIGHT_MIN = 0.5
WEIGHT_MAX = 5.0
WEIGHT_DEFAULT = 1.0
WEIGHT_CHANGE_MAX = 0.2  # 1회 조정 시 최대 변경폭


@dataclass(frozen=True)
class DefaultWeights:
    """기본 가중치"""
    cci_value: float = 1.0
    cci_slope: float = 1.0
    ma20_slope: float = 1.0
    candle: float = 1.0
    change: float = 1.0


# ============================================================
# CCI 점수 기준
# ============================================================

# CCI 값 점수 구간 (180 근접 시 최고점)
CCI_OPTIMAL = 180  # 최적 CCI 값
CCI_SCORE_RANGES = [
    # (min, max, score) - 180에 가까울수록 높은 점수
    (175, 185, 10.0),  # 최고점 (180 정중앙)
    (160, 175, 8.5),   # 높은 점수
    (185, 200, 8.5),   # 높은 점수
    (140, 160, 7.0),   # 중상 점수
    (200, 220, 6.0),   # 중간 점수 (과열 시작)
    (100, 140, 5.0),   # 중간 점수
    (220, 300, 4.0),   # 낮은 점수 (과열)
    (50, 100, 3.0),    # 낮은 점수
    (300, 400, 2.0),   # 감점 (고점 경고)
    (0, 50, 2.0),      # 감점 (저점)
]

# CCI 극단값
CCI_EXTREME_HIGH = 400  # 초과 시 강한 감점
CCI_EXTREME_LOW = 0     # 미만 시 감점


# ============================================================
# CCI 기울기 점수 기준
# ============================================================

# CCI 기울기 점수 (5일 기준)
CCI_SLOPE_STRONG_UP = 15      # 강한 상승세
CCI_SLOPE_UP = 8              # 상승세
CCI_SLOPE_SLIGHT_UP = 3       # 약한 상승세
CCI_SLOPE_FLAT = 0            # 횡보
CCI_SLOPE_WARNING_LEVEL = 200 # 이 레벨 이상에서 하락 시 추가 감점


# ============================================================
# MA20 기울기 점수 기준
# ============================================================

# MA20 기울기 점수 (7일 기준, 백분율)
MA20_SLOPE_STRONG_UP = 2.0    # 강한 상승세 (%)
MA20_SLOPE_UP = 1.0           # 상승세 (%)
MA20_SLOPE_SLIGHT_UP = 0.3    # 약한 상승세 (%)
MA20_SLOPE_FLAT = 0.1         # 횡보 범위 (±)
MA20_SLOPE_STRONG_DOWN = -2.0 # 강한 하락세 (%)


# ============================================================
# 양봉 품질 점수 기준
# ============================================================

# 윗꼬리 비율 기준
CANDLE_UPPER_WICK_EXCELLENT = 0.1   # 10% 이하 - 우수
CANDLE_UPPER_WICK_GOOD = 0.2        # 20% 이하 - 양호
CANDLE_UPPER_WICK_NORMAL = 0.3      # 30% 이하 - 보통
CANDLE_UPPER_WICK_BAD = 0.5         # 50% 이상 - 불량

# MA20 대비 위치 기준 (%)
CANDLE_MA20_ABOVE_OPTIMAL = 0.0     # MA20 위 안착 기준
CANDLE_MA20_ABOVE_OVERHEAT = 5.0    # 과열 기준 (MA20 대비 5% 이상)


# ============================================================
# 상승률 점수 기준
# ============================================================

# 상승률 점수 구간 (5~20% 최적)
CHANGE_OPTIMAL_MIN = 5.0   # 최적 상승률 하한
CHANGE_OPTIMAL_MAX = 20.0  # 최적 상승률 상한

CHANGE_SCORE_RANGES = [
    # (min, max, score)
    (10.0, 15.0, 10.0),  # 최고점 (10~15%)
    (7.0, 10.0, 9.0),    # 높은 점수
    (15.0, 18.0, 9.0),   # 높은 점수
    (5.0, 7.0, 8.0),     # 중상 점수
    (18.0, 20.0, 7.0),   # 중상 점수
    (3.0, 5.0, 6.0),     # 중간 점수
    (20.0, 25.0, 5.0),   # 감점 시작 (과열)
    (1.0, 3.0, 4.0),     # 낮은 점수 (모멘텀 부족)
    (25.0, 30.0, 3.0),   # 강한 감점 (추격 위험)
    (0.0, 1.0, 2.0),     # 감점
]

CHANGE_EXTREME_HIGH = 30.0  # 상한선 돌파 종목
CHANGE_NEGATIVE_PENALTY = 1.0  # 하락 시 점수


# ============================================================
# 필터링 상수
# ============================================================

# 거래대금 필터 (억원)
MIN_TRADING_VALUE = 300

# 제외 종목 패턴 (이름 기반)
# 참고: 더 포괄적인 필터는 src/utils/stock_filters.py의 EXCLUDE_KEYWORDS 사용
EXCLUDED_STOCK_PATTERNS = [
    # 인버스/레버리지
    "인버스",
    "레버리지",
    "레버",
    "2X",
    "2x",
    "3X",
    "3x",
    "곱버스",
    
    # ETF/ETN
    "ETF",
    "ETN",
    "KODEX",
    "TIGER",
    "KBSTAR",
    "ARIRANG",
    "HANARO",
    "KOSEF",
    "KINDEX",
    "SOL",
    "ACE",
    
    # 스팩/리츠
    "스팩",
    "SPAC",
    "리츠",
    "REIT",
    
    # 선물/파생
    "선물",
    "파생",
    
    # 우선주
    "우선주",
    "우B",
    "우C",
    
    # 전환사채/신주인수권
    "전환",
    "CB",
    "BW",
]

# 제외 종목 코드 접두사
EXCLUDED_CODE_PREFIXES = [
    "Q",   # 코넥스
]


# ============================================================
# API 관련 상수
# ============================================================

# Rate Limit (안전 마진 적용)
API_CALLS_PER_SECOND = 8     # 초당 8회 (공식: 10회)
API_CALL_INTERVAL = 0.12     # 0.12초 간격

# 재시도 설정
API_MAX_RETRIES = 3
API_RETRY_DELAY = 1.0        # 재시도 대기 시간 (초)

# 토큰 갱신 버퍼 (초)
TOKEN_REFRESH_BUFFER = 3600  # 만료 1시간 전 갱신


# ============================================================
# 시스템 상수
# ============================================================

# 스크리닝 결과
TOP_N_COUNT = 3  # TOP 3 선정

# 최소 데이터 요구량
MIN_DAILY_DATA_COUNT = 20  # 최소 20일 일봉 필요

# 학습 최소 샘플
MIN_LEARNING_SAMPLES = 30  # 최소 30일 데이터 수집 후 가중치 조정


# ============================================================
# 에러 코드
# ============================================================

class ErrorCode(Enum):
    """에러 코드 정의"""
    # Screening 관련
    SCREEN_001 = "한투 API 인증 실패"
    SCREEN_002 = "한투 API 호출 실패"
    SCREEN_003 = "필터링 종목 0개"
    SCREEN_004 = "점수 계산 실패"
    SCREEN_005 = "DB 저장 실패"
    
    # Notify 관련
    NOTIFY_001 = "웹훅 URL 무효"
    NOTIFY_002 = "Rate Limit"
    NOTIFY_003 = "네트워크 오류"
    NOTIFY_004 = "메시지 포맷 오류"
    
    # KIS API 관련
    KIS_001 = "토큰 발급 실패"
    KIS_002 = "토큰 만료"
    KIS_003 = "요청 한도 초과"
    KIS_004 = "잘못된 종목코드"
    
    # DB 관련
    DB_001 = "연결 실패"
    DB_002 = "쿼리 실행 실패"
    DB_003 = "데이터 무결성 오류"


# ============================================================
# 메시지 상수
# ============================================================

# 디스코드 Embed 색상
DISCORD_COLOR_SUCCESS = 3066993   # 녹색
DISCORD_COLOR_WARNING = 16776960  # 노란색
DISCORD_COLOR_ERROR = 15158332    # 빨간색

# 메시지 템플릿
MSG_NO_CANDIDATES = "적합한 종목이 없습니다."
MSG_PREVIEW_LABEL = "[프리뷰]"
MSG_MAIN_LABEL = "[최종]"


if __name__ == "__main__":
    # 상수 확인용
    print(f"CCI Period: {CCI_PERIOD}")
    print(f"MA20 Period: {MA20_PERIOD}")
    print(f"CCI Slope Period: {CCI_SLOPE_PERIOD}")
    print(f"MA20 Slope Period: {MA20_SLOPE_PERIOD}")
    print(f"Weight Range: {WEIGHT_MIN} ~ {WEIGHT_MAX}")
    print(f"Default Weights: {DefaultWeights()}")
