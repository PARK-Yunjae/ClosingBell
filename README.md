# 🔔 ClosingBell v5.4

**종가매매 자동 스크리닝 & 학습 시스템 (백테스트 최적화 버전)**

한국투자증권 API를 활용한 종목 자동 스크리닝 시스템입니다.
매일 장 마감 전 기술적 분석을 수행하고 TOP5 종목을 추천합니다.
**실제 매매는 하지 않으며**, 알림 발송 + 익일 결과 학습 + 자동 최적화를 수행합니다.

## ✨ v5.4 주요 변경사항 (백테스트 기반)

### 📊 백테스트 결과 (2016-2026, 6,999건)
| 지표 | 결과 | 조치 |
|------|------|------|
| **D+1 시초가 매도** | 승률 54.5% | ✅ 최적 전략 확정 |
| **CCI 150~170** | 승률 55.5% | ✅ 구간 하향 조정 |
| **연속양봉 4일** | 승률 50.9% ⚠️ | ✅ 감점 강화 (13점→5점) |
| **K값 전략** | 승률 49.0% ❌ | ❌ 제거 |
| **나스닥 폭락(-2%↓)** | 승률 57.2% 🏆 | ✅ 역발상 보너스 |

### 🔧 변경 내역
```diff
+ CCI 최적 구간: 160~180 → 150~170 (승률 +0.4%p)
+ 연속양봉 4일: 13점 → 5점 (백테스트 50.9% 급락 반영)
+ 연속양봉 5일+: 7점 → 0~2점
+ 글로벌 지표 필터 추가 (나스닥/환율)
+ 나스닥 폭락(-2%↓) 시 +5점 보너스 (역발상)
+ 나스닥↑ & 환율↓ 시 +3점 보너스
- K값 전략 제거 (승률 49% 부적합)
- --run-k 옵션 삭제
```

## 📊 종가매매 점수 체계 (100점 만점)

| 지표 | 배점 | 최적 구간 | v5.4 변경 |
|------|------|----------|----------|
| 거래량비 | 15점 | 1.5~3.0배 | - |
| 등락률 | 15점 | 2~8% | - |
| **연속양봉** | 15점 | 2~3일 | ⚠️ 4일 이상 강한 감점 |
| **CCI** | 15점 | **150~170** | ✅ 구간 하향 |
| 이격도 | 15점 | 2~8% | - |
| 캔들품질 | 15점 | 윗꼬리 ≤40% | - |
| 보너스 | 10점 | CCI상승/MA20/캔들 | - |

### 연속양봉 점수 (v5.4 수정)
| 연속양봉 | 백테스트 승률 | v5.3 점수 | v5.4 점수 |
|----------|--------------|-----------|-----------|
| 2~3일 | 54.9% ✅ | 15점 | 15점 |
| 4일 | **50.9%** ⚠️ | 13점 | **5점** |
| 5일+ | ~50% | 7~1점 | **0~2점** |

## 🌍 글로벌 지표 필터 (v5.4 신규)

| 조건 | 백테스트 승률 | 점수 조정 |
|------|--------------|----------|
| 나스닥 폭락(-2%↓) | **57.2%** 🏆 | **+5점** (역발상) |
| 나스닥↑ & 환율↓ | 55.2% | +3점 |
| 기본 | 54.5% | 0점 |

> ⚡ **예상과 다른 결과**: 나스닥 폭락 다음날 한국 종가매매 승률이 오히려 높음!

## 📅 자동 스케줄

| 시간 | 작업 | 설명 |
|------|------|------|
| 12:30 | 프리뷰 스크리닝 | TOP5 알림 (저장 안함) |
| 15:00 | 메인 스크리닝 | TOP5 알림 + DB 저장 |
| 16:30 | 데이터 갱신 | OHLCV 업데이트 |
| 17:00 | 학습 | 익일 결과 수집 + 가중치 자동 조정 |
| 17:35 | Git 자동 커밋 | 변경사항 백업 |
| 17:40 | 자동 종료 | 프로그램 종료 |

## 🚀 설치 및 실행

### 1. 환경 설정
```bash
python -m venv venv
venv\Scripts\activate
pip install -r requirements.txt
```

### 2. API 설정 (.env)
```env
KIS_APP_KEY="your_app_key"
KIS_APP_SECRET="your_app_secret"
KIS_ACCOUNT_NO="12345678-01"
DISCORD_WEBHOOK_URL="https://discord.com/..."
```

### 3. 실행
```bash
# 스케줄러 모드 (17:40 자동 종료)
python main.py

# 즉시 스크리닝 (테스트)
python main.py --run-test

# 특정 종목 점수 확인
python main.py --check 005930

# 대시보드
streamlit run dashboard/app.py
```

## 📁 프로젝트 구조

```
ClosingBell/
├── src/
│   ├── adapters/           # 외부 API
│   │   ├── kis_client.py
│   │   └── discord_notifier.py
│   ├── services/           # 비즈니스 로직
│   │   ├── screener_service.py   # 스크리닝
│   │   ├── learner_service.py    # 학습
│   │   └── data_updater.py       # 데이터 갱신
│   ├── domain/             # 도메인 모델
│   │   ├── score_calculator.py   # 점수 계산 (v5.4)
│   │   └── models.py
│   ├── data/               # 글로벌 지표
│   │   └── index_monitor.py      # 나스닥/환율 조회 (v5.4)
│   ├── infrastructure/     # 인프라
│   │   ├── scheduler.py
│   │   ├── repository.py
│   │   └── database.py
│   └── config/             # 설정
├── dashboard/              # Streamlit
├── data/                   # SQLite DB
└── logs/                   # 로그 파일
```

## 📝 버전 히스토리

### v5.4 (현재) - 백테스트 최적화
- 📊 8년 백테스트 결과 반영 (2016-2026, 6,999건)
- ✅ CCI 구간 조정 (160~180 → 150~170)
- ✅ 연속양봉 4일 이상 강한 감점
- ✅ 글로벌 지표 필터 추가 (나스닥/환율)
- ❌ K값 전략 제거 (승률 49% 부적합)

### v5.3
- K값 변동성 돌파 전략 추가

### v5.2
- 유목민 공부법 자동화
- 그리드서치 최적 가중치 적용

### v5.1
- 100점 만점 정규화
- 소프트 필터 방식 도입

---

## 💡 백테스트 핵심 인사이트

```
1. D+1 시초가 매도가 최적 (54.5%)
   → 홀딩할수록 승률 하락 (D+3: 46.3%, D+5: 45.7%)

2. 나스닥 폭락(-2%↓) 다음날 오히려 승률 최고 (57.2%)
   → 역발상 매매 기회!

3. TOP4~5는 통계적으로 유의미하게 나쁘지 않음
   → TOP5 유지 (리스크 분산)

4. 연속양봉 4일부터 급락 (54.9% → 50.9%)
   → 과열 신호로 강한 감점
```

---
*ClosingBell v5.4 - 백테스트 최적화 버전* 🔔
