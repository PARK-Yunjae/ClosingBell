# 📊 ClosingBell v5.3 - 전략 가이드

> 최종 업데이트: 2026-01-16  
> 버전: v5.3 (단순화)  
> 철학: **"차트가 모든 것을 반영한다"** 📈

---

## 🎯 시스템 개요

ClosingBell은 **두 가지 기술적 분석 전략**을 자동화한 시스템입니다.

| 전략 | 승률 | 매수 시점 | 매도 시점 |
|------|------|----------|----------|
| **종가매매 TOP5** | 60.7% | 15:20 (장 마감 직전) | 익일 시가 |
| **K값 돌파 TOP3** | 75.3% | 장중 돌파 시 | 익일 시가 |

---

## 📈 전략 1: K값 변동성 돌파

래리 윌리엄스(Larry Williams)의 변동성 돌파 전략을 한국 시장에 최적화

### 핵심 공식

```
돌파가 = 당일 시가 + (전일 고가 - 전일 저가) × 0.3

현재가 ≥ 돌파가 → 매수 → 익일 시가 매도
```

### 필터 조건 (백테스트 최적)

| 조건 | 값 | 설명 |
|------|-----|------|
| K값 | 0.3 | 돌파 민감도 |
| 거래대금 | 100억+ | 유동성 확보 |
| 거래량 순위 | 100위 | 시장 관심 종목 |
| 볼륨 비율 | 3.0x+ | 20일 평균 대비 |
| 전일 등락 | 0~10% | 양봉 + 과열 방지 |

### 백테스트 성과 (2016~2026, 10년)

- **총 시그널**: 32,929건
- **승률**: 75.3%
- **평균 수익**: +6.22%
- **일평균 시그널**: 9.5개

---

## 🔔 전략 2: 종가매매 (점수제)

100점 만점 점수로 종목 평가 → TOP5 선정 → 익일 시가 매도

### 점수 체계 (100점 만점)

#### 핵심 지표 (90점)

| 지표 | 배점 | 최적 구간 |
|------|------|----------|
| CCI(20) | 15점 | 140~200 |
| 등락률 | 15점 | 1~8% |
| 이격도 | 15점 | 102~108% (MA20 대비) |
| 연속양봉 | 15점 | 2~4일 |
| 거래량비 | 15점 | 2~5x |
| 캔들품질 | 15점 | 상체 큰 양봉 |

#### 보너스 (10점)

| 조건 | 배점 |
|------|------|
| CCI 상승중 | 4점 |
| MA20 3일 상승 | 3점 |
| 고가 ≠ 종가 | 3점 |

### 등급별 매도 전략

| 등급 | 점수 | 시초 매도 | 목표 홀딩 | 손절 |
|------|------|----------|----------|------|
| **S** | 85+ | 30% | 70% (+4%) | -3% |
| **A** | 75-84 | 40% | 60% (+3%) | -2.5% |
| **B** | 65-74 | 50% | 50% (+2.5%) | -2% |
| **C** | 55-64 | 70% | 30% (+2%) | -1.5% |
| **D** | <55 | 100% | 0% | -1% |

---

## ⏰ 스케줄

| 시간 | 작업 |
|------|------|
| 12:30 | 프리뷰 스크리닝 |
| 15:00 | **메인 스크리닝 (매수 타이밍)** |
| 16:30 | OHLCV 데이터 갱신 |
| 17:00 | **익일 결과 수집 (승률 추적)** |
| 17:35 | Git 커밋 |
| 17:40 | 자동 종료 |

---

## 📊 대시보드 (Streamlit)

### 메인 페이지 (`app.py`)
- 전체 승률 게이지
- 누적 수익률 그래프
- 일별 갭수익률 바 차트
- 최근 결과 테이블

### 날짜별 결과 (`01_📅_날짜별결과.py`)
- 사이드바에서 년/월/일 선택
- 해당 날짜 추천 종목 리스트
- 각 종목의 익일 시고저종 결과

```bash
# 대시보드 실행
streamlit run dashboard/app.py
```

---

## 🗂️ 파일 구조

```
ClosingBell/
├── main.py                      # 진입점
├── src/
│   ├── domain/
│   │   ├── score_calculator.py  # 종가매매 점수
│   │   ├── k_breakout.py        # K값 전략
│   │   └── indicators.py        # 기술적 지표
│   ├── services/
│   │   ├── screener_service.py  # 종가매매 스크리너
│   │   ├── k_screener.py        # K값 스크리너
│   │   ├── result_collector.py  # ⭐ 익일 결과 수집
│   │   └── data_updater.py      # OHLCV 갱신
│   ├── adapters/
│   │   ├── kis_client.py        # 한투 API
│   │   └── discord_notifier.py  # Discord
│   └── infrastructure/
│       ├── scheduler.py         # 스케줄러
│       ├── repository.py        # DB
│       └── database.py          # SQLite
└── dashboard/
    ├── app.py                   # 메인 (승률 그래프)
    └── pages/
        └── 01_📅_날짜별결과.py   # 날짜별 상세
```

### ❌ v5.3에서 삭제된 것들

| 파일 | 삭제 이유 |
|------|----------|
| learner_service.py | AI 학습 불필요 |
| k_learner_service.py | K값 AI 학습 불필요 |
| nomad_study.py | 뉴스/공부는 직접 수행 |
| gemini_client.py | AI 요약 불필요 |
| naver_client.py | 뉴스 수집 불필요 |
| ai_*_backtest.py | AI 백테스트 효과 없음 |

---

## 💡 Claude의 의견 & 제안

### ✅ 잘된 점

1. **단순화 결정이 탁월합니다**
   - AI(Qwen3 8B) 백테스트 결과 98%가 BUY 판정 → 분별력 없음
   - 복잡성 제거로 유지보수 용이

2. **백테스트 기반 파라미터**
   - 감이 아닌 데이터로 K=0.3, CCI 140~200 등 결정
   - 10년치 데이터로 검증

3. **"차트가 모든 것을 반영한다" 철학**
   - 뉴스, 재무제표 분석 배제
   - 가격과 거래량만으로 판단

### ⚠️ 개선 제안

#### 1. 리스크 관리 강화

```python
# 현재: 고정 손절
stop_loss = -2%

# 제안: ATR 기반 동적 손절
atr = calculate_atr(14)
stop_loss = -1.5 * atr  # 변동성에 따라 조정
```

**이유**: 변동성 큰 종목은 -2%가 너무 좁고, 변동성 작은 종목은 너무 넓음

#### 2. 시장 상황 필터

```python
# 현재: 개별 종목만 판단

# 제안: 지수 상태 확인
if kospi < ma20 or kospi_change < -1.5%:
    reduce_position_size()  # 베팅 사이즈 축소
```

**이유**: 하락장에서는 개별 종목 아무리 좋아도 같이 빠짐

#### 3. 분할 매수 전략

```python
# 현재: 1회 올인 매수

# 제안: 3회 분할
entry_1: 50% (첫 진입)
entry_2: 30% (-2% 하락 시)
entry_3: 20% (-4% 하락 시)
```

**이유**: 평단가 낮추기 + 리스크 분산

#### 4. 백테스트 한계 인식

| 항목 | 백테스트 | 실전 |
|------|---------|------|
| 슬리피지 | 없음 | 0.1~0.5% |
| 수수료 | 없음 | 0.015% |
| 체결 실패 | 없음 | 가끔 발생 |
| **예상 승률 차이** | 기준 | **-5~10%p** |

**결론**: 실전 승률은 백테스트보다 낮을 수 있음 → 소액으로 검증 필요

### 🔮 향후 발전 방향

#### 단기 (1~2주)
- 실시간 K값 돌파 알림 (장중)
- Discord 알림 포맷 개선

#### 중기 (1개월)
- 포트폴리오 최적화 (상관관계 낮은 종목 분산)
- Kelly 기준 베팅 사이즈 계산

#### 장기 (3개월+)
- 자동매매 연동 (한투 API 주문)
- 웹 대시보드 배포 (Streamlit Cloud)

### 💬 총평

> **현재 시스템은 실용적이고 잘 설계되어 있습니다.**

K값 75% 승률은 매우 좋은 수치이고, AI를 제거한 결정도 현명합니다. 
다만 실전에서는 백테스트보다 낮은 성과가 나올 수 있으니,
처음에는 **소액(총 자금의 10~20%)**으로 1~2개월 테스트 후
점진적으로 확대하시길 권장합니다.

**가장 중요한 것은 손절 규칙을 철저히 지키는 것입니다.**

---

## 🚀 사용법

```bash
# 1. 환경 설정
copy .env.example .env
# .env 파일에 API 키 입력

# 2. 의존성 설치
pip install -r requirements.txt

# 3. 실행
python main.py              # 스케줄러 모드
python main.py --run        # 종가매매 즉시 실행
python main.py --run-k      # K값 돌파 즉시 실행
python main.py --run-all    # 전체 테스트

# 4. 대시보드
streamlit run dashboard/app.py
```

---

## ⚠️ 면책 조항

1. 과거 성과는 미래를 보장하지 않습니다
2. 투자 손실에 대한 책임은 본인에게 있습니다
3. 자금 관리: 1종목당 10% 이하 권장
4. 손절 규칙을 반드시 준수하세요

---

> 📈 **"차트가 모든 것을 반영한다"** - 기술적 분석의 핵심
