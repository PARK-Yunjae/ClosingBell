# 3. 핵심 사용자 흐름 (User Flows)

**프로젝트명:** 종가매매 스크리너  
**버전:** 1.0  
**작성일:** 2025-01-06  

---

## 3.1 개요

### 3.1.1 결론
5개의 핵심 사용자 흐름을 시퀀스 다이어그램 형태로 정의하여 시스템 동작을 명확히 한다.

### 3.1.2 근거
- 시스템 컴포넌트 간 상호작용 명확화
- 에러 케이스 및 분기 사전 정의
- 개발/테스트 시나리오로 활용

### 3.1.3 리스크/대안
| 리스크 | 대안 |
|--------|------|
| API 응답 지연으로 타임아웃 | 재시도 로직 + 타임아웃 설정 |
| 동시 실행 충돌 | 락(Lock) 메커니즘 적용 |

---

## 3.2 Flow 1: 15:00 스크리닝 및 알림 (메인 플로우)

### 3.2.1 설명
매일 15:00에 자동 실행되어 종가매매 후보 TOP 3를 선정하고 알림을 발송하는 핵심 플로우

### 3.2.2 시퀀스 다이어그램 (텍스트)

```
┌─────────┐     ┌──────────┐     ┌────────────┐     ┌────────┐     ┌─────────┐
│Scheduler│     │ Screener │     │ KIS API    │     │ SQLite │     │ Discord │
└────┬────┘     └────┬─────┘     └─────┬──────┘     └───┬────┘     └────┬────┘
     │               │                 │                │               │
     │ 1. trigger    │                 │                │               │
     │ (15:00 cron)  │                 │                │               │
     │──────────────>│                 │                │               │
     │               │                 │                │               │
     │               │ 2. 전종목 거래대금 조회           │               │
     │               │────────────────>│                │               │
     │               │                 │                │               │
     │               │ 3. 거래대금 데이터 반환           │               │
     │               │<────────────────│                │               │
     │               │                 │                │               │
     │               │ 4. 100억 이상 필터링 (내부)       │               │
     │               │ ~~~~~~~~~~~~~~~>│                │               │
     │               │                 │                │               │
     │               │ 5. 필터링 종목 일봉 조회 (loop)   │               │
     │               │────────────────>│                │               │
     │               │                 │                │               │
     │               │ 6. 일봉 데이터 반환              │               │
     │               │<────────────────│                │               │
     │               │                 │                │               │
     │               │ 7. 기술지표 계산 (내부)          │               │
     │               │    - CCI(14), CCI기울기          │               │
     │               │    - MA20 기울기                 │               │
     │               │    - 양봉 품질                   │               │
     │               │    - 상승률                      │               │
     │               │ ~~~~~~~~~~~~~~~>│                │               │
     │               │                 │                │               │
     │               │ 8. 점수 산출 및 TOP 3 선정 (내부) │               │
     │               │ ~~~~~~~~~~~~~~~>│                │               │
     │               │                 │                │               │
     │               │ 9. 전체 결과 저장                │               │
     │               │────────────────────────────────>│               │
     │               │                 │                │               │
     │               │ 10. 저장 완료                    │               │
     │               │<────────────────────────────────│               │
     │               │                 │                │               │
     │               │ 11. TOP 3 알림 메시지 구성       │               │
     │               │ ~~~~~~~~~~~~~~~>│                │               │
     │               │                 │                │               │
     │               │ 12. 웹훅 POST                    │               │
     │               │────────────────────────────────────────────────>│
     │               │                 │                │               │
     │               │ 13. 200 OK                       │               │
     │               │<────────────────────────────────────────────────│
     │               │                 │                │               │
     │ 14. 완료 로그 │                 │                │               │
     │<──────────────│                 │                │               │
     │               │                 │                │               │
```

### 3.2.3 단계별 상세

| Step | Actor | Action | 성공 조건 | 실패 처리 |
|------|-------|--------|----------|----------|
| 1 | Scheduler | 15:00 cron 트리거 | 정시 실행 | 1분 후 재시도 |
| 2-3 | Screener → KIS API | 전종목 거래대금 조회 | 데이터 수신 | 3회 재시도 후 실패 알림 |
| 4 | Screener | 100억 필터 + ETF/스팩 제외 | 종목 리스트 생성 | 빈 리스트 시 종료 |
| 5-6 | Screener → KIS API | 종목별 일봉 조회 | 모든 종목 수신 | 실패 종목 제외 후 진행 |
| 7 | Screener | 기술지표 계산 | 5개 지표 산출 | 계산 불가 종목 0점 |
| 8 | Screener | TOP 3 선정 | 3개 이상 종목 | 3개 미만 시 있는 만큼 |
| 9-10 | Screener → SQLite | 결과 저장 | INSERT 성공 | 로깅 후 알림 진행 |
| 11 | Screener | 메시지 구성 | 포맷팅 완료 | - |
| 12-13 | Screener → Discord | 웹훅 발송 | 200 응답 | 1회 재시도 |
| 14 | Scheduler | 완료 로그 | 로그 기록 | - |

---

## 3.3 Flow 2: 12:30 프리뷰 알림

### 3.3.1 설명
12:30에 실행되어 프리뷰 알림만 발송하고 DB 저장은 하지 않는 플로우

### 3.3.2 시퀀스 다이어그램 (텍스트)

```
┌─────────┐     ┌──────────┐     ┌────────────┐     ┌─────────┐
│Scheduler│     │ Screener │     │ KIS API    │     │ Discord │
└────┬────┘     └────┬─────┘     └─────┬──────┘     └────┬────┘
     │               │                 │                 │
     │ 1. trigger    │                 │                 │
     │ (12:30 cron)  │                 │                 │
     │──────────────>│                 │                 │
     │               │                 │                 │
     │               │ 2. 전종목 거래대금 조회           │
     │               │────────────────>│                 │
     │               │                 │                 │
     │               │ 3. 데이터 반환                    │
     │               │<────────────────│                 │
     │               │                 │                 │
     │               │ 4. 필터링 + 일봉 조회 + 점수 산출 │
     │               │────────────────>│                 │
     │               │<────────────────│                 │
     │               │                 │                 │
     │               │ 5. TOP 3 선정 (메모리만)          │
     │               │ ~~~~~~~~~~~~~~~>│                 │
     │               │                 │                 │
     │               │ ※ DB 저장 SKIP                   │
     │               │                 │                 │
     │               │ 6. "[프리뷰]" 라벨 포함 메시지    │
     │               │────────────────────────────────>│
     │               │                 │                 │
     │               │ 7. 200 OK                        │
     │               │<────────────────────────────────│
     │               │                 │                 │
     │ 8. 완료       │                 │                 │
     │<──────────────│                 │                 │
```

### 3.3.3 Flow 1과의 차이점

| 구분 | Flow 1 (15:00) | Flow 2 (12:30) |
|------|----------------|----------------|
| DB 저장 | O | X |
| 알림 라벨 | 없음 | "[프리뷰]" |
| 실패 시 영향 | 크리티컬 | 무시 가능 |

---

## 3.4 Flow 3: 익일 결과 수집 및 가중치 조정

### 3.4.1 설명
장 종료 후(16:00) 전일 스크리닝 종목의 익일 결과를 수집하고 가중치를 조정하는 플로우

### 3.4.2 시퀀스 다이어그램 (텍스트)

```
┌─────────┐     ┌──────────┐     ┌────────────┐     ┌────────┐     ┌──────────┐
│Scheduler│     │ Learner  │     │ KIS API    │     │ SQLite │     │ Optimizer│
└────┬────┘     └────┬─────┘     └─────┬──────┘     └───┬────┘     └────┬─────┘
     │               │                 │                │               │
     │ 1. trigger    │                 │                │               │
     │ (16:00 cron)  │                 │                │               │
     │──────────────>│                 │                │               │
     │               │                 │                │               │
     │               │ 2. 전일 스크리닝 종목 조회       │               │
     │               │────────────────────────────────>│               │
     │               │                 │                │               │
     │               │ 3. 종목 리스트 반환              │               │
     │               │<────────────────────────────────│               │
     │               │                 │                │               │
     │               │ 4. 각 종목 당일 데이터 조회      │               │
     │               │────────────────>│                │               │
     │               │                 │                │               │
     │               │ 5. 시초가, 종가, 고가 반환       │               │
     │               │<────────────────│                │               │
     │               │                 │                │               │
     │               │ 6. 익일 결과 계산 (내부)         │               │
     │               │    - 시초가 상승/하락            │               │
     │               │    - 당일 수익률                 │               │
     │               │    - 고점 대비 등락              │               │
     │               │ ~~~~~~~~~~~~~~~>│                │               │
     │               │                 │                │               │
     │               │ 7. 결과 업데이트                 │               │
     │               │────────────────────────────────>│               │
     │               │                 │                │               │
     │               │ 8. 업데이트 완료                 │               │
     │               │<────────────────────────────────│               │
     │               │                 │                │               │
     │               │ 9. 30일 이상 데이터 확인         │               │
     │               │────────────────────────────────>│               │
     │               │                 │                │               │
     │               │ 10. 데이터 카운트 반환           │               │
     │               │<────────────────────────────────│               │
     │               │                 │                │               │
     │               │ [조건: 30일 이상]                │               │
     │               │ 11. 최적화 요청                  │               │
     │               │────────────────────────────────────────────────>│
     │               │                 │                │               │
     │               │ 12. 지표-적중률 상관분석         │               │
     │               │<────────────────────────────────────────────────│
     │               │                 │                │               │
     │               │ 13. 새 가중치 저장               │               │
     │               │────────────────────────────────>│               │
     │               │                 │                │               │
     │               │ 14. 가중치 변경 로그 저장        │               │
     │               │────────────────────────────────>│               │
     │               │                 │                │               │
     │ 15. 완료      │                 │                │               │
     │<──────────────│                 │                │               │
```

### 3.4.3 가중치 조정 로직

```
입력: 30일 이상의 (지표점수, 익일시초상승여부) 데이터
처리:
  1. 각 지표별로 "해당 지표 점수가 높은 종목 그룹"의 익일 상승률 계산
  2. 상관관계가 높은 지표 → 가중치 UP (최대 2.0)
  3. 상관관계가 낮은 지표 → 가중치 DOWN (최소 0.5)
  4. 변경 폭 제한: 1회 조정 시 ±0.1 이내
출력: 새로운 가중치 세트 (5개)
```

---

## 3.5 Flow 4: 수동 매매일지 입력 (Streamlit)

### 3.5.1 설명
사용자가 Streamlit 대시보드에서 수동 매매 결과를 입력하는 플로우

### 3.5.2 시퀀스 다이어그램 (텍스트)

```
┌──────┐     ┌───────────┐     ┌────────┐
│ User │     │ Streamlit │     │ SQLite │
└──┬───┘     └─────┬─────┘     └───┬────┘
   │               │                │
   │ 1. 대시보드 접속               │
   │──────────────>│                │
   │               │                │
   │ 2. 매매일지 입력 폼 표시       │
   │<──────────────│                │
   │               │                │
   │ 3. 입력값 작성                 │
   │   - 날짜                       │
   │   - 종목코드                   │
   │   - 매수가, 매도가             │
   │   - 수익률 (자동계산)          │
   │   - 메모                       │
   │               │                │
   │ 4. "저장" 버튼 클릭            │
   │──────────────>│                │
   │               │                │
   │               │ 5. 입력값 검증 (내부)
   │               │    - 종목코드 유효성
   │               │    - 날짜 형식
   │               │    - 숫자 범위
   │               │                │
   │               │ [검증 실패]    │
   │ 6a. 에러 메시지 표시           │
   │<──────────────│                │
   │               │                │
   │               │ [검증 성공]    │
   │               │ 6b. INSERT     │
   │               │───────────────>│
   │               │                │
   │               │ 7. 저장 완료   │
   │               │<───────────────│
   │               │                │
   │ 8. 성공 메시지 + 일지 목록 갱신│
   │<──────────────│                │
   │               │                │
```

### 3.5.3 입력 필드 정의

| 필드 | 타입 | 필수 | 설명 |
|------|------|------|------|
| trade_date | DATE | O | 매매일 |
| stock_code | VARCHAR(6) | O | 종목코드 |
| stock_name | VARCHAR(50) | X | 종목명 (자동완성) |
| buy_price | INTEGER | O | 매수가 |
| sell_price | INTEGER | X | 매도가 (미체결 시 NULL) |
| quantity | INTEGER | O | 수량 |
| return_rate | FLOAT | X | 수익률 (자동계산) |
| memo | TEXT | X | 메모 |
| screening_id | INTEGER | X | 연결된 스크리닝 ID (FK) |

---

## 3.6 Flow 5: 대시보드 데이터 조회 및 시각화

### 3.6.1 설명
Streamlit 대시보드에서 전체 데이터를 조회하고 시각화하는 플로우

### 3.6.2 시퀀스 다이어그램 (텍스트)

```
┌──────┐     ┌───────────┐     ┌────────┐
│ User │     │ Streamlit │     │ SQLite │
└──┬───┘     └─────┬─────┘     └───┬────┘
   │               │                │
   │ 1. 대시보드 메인 접속          │
   │──────────────>│                │
   │               │                │
   │               │ 2. 최근 30일 스크리닝 결과 조회
   │               │───────────────>│
   │               │                │
   │               │ 3. 결과 데이터 │
   │               │<───────────────│
   │               │                │
   │               │ 4. 현재 가중치 조회
   │               │───────────────>│
   │               │                │
   │               │ 5. 가중치 데이터
   │               │<───────────────│
   │               │                │
   │               │ 6. 매매일지 요약 조회
   │               │───────────────>│
   │               │                │
   │               │ 7. 일지 데이터 │
   │               │<───────────────│
   │               │                │
   │ 8. 대시보드 렌더링             │
   │   - 요약 카드 (적중률, 수익률) │
   │   - TOP 3 적중률 차트          │
   │   - 지표별 가중치 게이지       │
   │   - 최근 스크리닝 테이블       │
   │   - 매매일지 요약              │
   │<──────────────│                │
   │               │                │
   │ 9. 필터 적용 (날짜, 종목 등)   │
   │──────────────>│                │
   │               │                │
   │               │ 10. 필터된 데이터 조회
   │               │───────────────>│
   │               │                │
   │               │ 11. 결과       │
   │               │<───────────────│
   │               │                │
   │ 12. 필터링된 대시보드 갱신     │
   │<──────────────│                │
   │               │                │
```

### 3.6.3 대시보드 화면 구성

```
┌─────────────────────────────────────────────────────────────┐
│                    종가매매 스크리너 대시보드                  │
├──────────────────┬──────────────────┬───────────────────────┤
│   📊 적중률       │   💰 총 수익률    │   📈 가중치 상태      │
│     67%          │     +12.3%       │     정상              │
├──────────────────┴──────────────────┴───────────────────────┤
│                                                             │
│  [일별 TOP 3 적중률 추이 차트]                               │
│  ▁▃▅▇█▇▅▃▁▂▄▆█▇▅                                           │
│                                                             │
├─────────────────────────────────────────────────────────────┤
│  지표별 가중치                                              │
│  CCI 값:     ████████░░ 1.2                                │
│  CCI 기울기: █████████░ 1.4                                │
│  MA20 기울기: ███████░░░ 1.0                                │
│  양봉 품질:  ██████░░░░ 0.8                                 │
│  상승률:    █████░░░░░ 0.7                                  │
├─────────────────────────────────────────────────────────────┤
│  최근 스크리닝 결과                   [필터: 날짜 ▼]        │
│  ┌─────────┬────────┬───────┬──────┬───────────┐          │
│  │ 날짜     │ 종목   │ 점수  │ 순위 │ 익일상승  │          │
│  ├─────────┼────────┼───────┼──────┼───────────┤          │
│  │ 01/06   │ 삼성   │ 8.5   │ 1    │ ↑ +2.3%  │          │
│  │ 01/06   │ LG     │ 8.2   │ 2    │ ↓ -1.1%  │          │
│  └─────────┴────────┴───────┴──────┴───────────┘          │
└─────────────────────────────────────────────────────────────┘
```

---

## 3.7 문서 이력

| 버전 | 날짜 | 변경 내용 | 작성자 |
|------|------|----------|--------|
| 1.0 | 2025-01-06 | 초안 작성 | Architect AI |

---

**이전 문서:** [02_User_Stories.md](./02_User_Stories.md)  
**다음 문서:** [04_Database_Design.md](./04_Database_Design.md)
