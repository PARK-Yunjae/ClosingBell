# ClosingBell v6.2 개선 기획서

> 최근 대화 분석 (2026-01-13 ~ 2026-01-20) 기반

---

## 📊 현재 문제점 분석

### 1. CCI 과열 종목이 TOP5에 포함됨 ❌

**데이터 분석:**
| 날짜 | 순위 | 종목 | CCI | 점수 |
|------|------|------|-----|------|
| 1/16 | #2 | 아센디오 | **467** | 81.9 |
| 1/16 | #3 | 대우건설 | **452** | 79.7 |
| 1/15 | #2 | 버넥트 | **479** | 82.4 |
| 1/15 | #4 | 신화콘텍 | **489** | 78.5 |
| 1/13 | #1 | 한켐 | **578** | 86.9 |
| 1/13 | #4 | 일지테크 | **542** | 83.0 |

**문제점:**
- CCI 400~500대 = 극도의 과열 상태
- 다른 지표(거래량, 등락률 등)가 높아서 총점이 여전히 높음
- 1/12 대화: "한국전력 CCI 262가 불안해서 2픽 샀는데, 맞는 판단이었다"

### 2. TOP1 < TOP2-3 성과 역설 ❌

**1/19 대화 핵심:**
> "1등은 자꾸 떨어지고 2등부터 오르던데... 무지성 1등 매수해도 이익 보려고 한건데"

**백테스트 결과 (이전 대화):**
- TOP1 승률: ~52%
- TOP2-3 승률: ~55%
- 격차 원인: TOP1은 이미 "뉴스에 노출된" 종목일 가능성

### 3. 대기업 필터 부재 ❌

**1/19 대화:**
> "친구가 TOP5 중 대기업만 매수해서 수익 냈다. 배아프다고 놀림 당함"

**논리:**
- 대기업 = 급등 후 급락 적음 (변동성 낮음)
- 유동성 좋아서 탈출 쉬움
- 시가총액 상위 N% 필터 or 점수 보너스 필요

---

## 🎯 개선 사항 (우선순위순)

### Phase 1: 긴급 수정 (즉시)

#### 1-1. CCI 하드 필터 추가

```python
# score_calculator.py 또는 screener_service.py

# 기존: CCI 아무리 높아도 점수만 낮을 뿐 TOP5 진입 가능
# 변경: CCI 250+ 이면 TOP5 후보에서 제외

CCI_HARD_LIMIT = 250  # 250 이상이면 제외

def filter_by_cci(stocks: List[StockScoreV5]) -> List[StockScoreV5]:
    """CCI 과열 종목 제외"""
    return [s for s in stocks if s.score_detail.raw_cci <= CCI_HARD_LIMIT]
```

**효과:**
- 1/13~1/16 TOP5 중 50% 이상이 필터링됨
- 실패 확률 높은 종목 사전 제거

#### 1-2. CCI 점수 곡선 강화

```python
# 현재 (v5.4)
CCI 250: 5점/15점
CCI 300: 2.5점/15점
CCI 350+: 0점

# 변경 (v6.2)
CCI 220+: 감점 시작 (양호→보통)
CCI 250+: 하드 필터 (TOP5 제외)
```

### Phase 2: 대기업 우대 (이번 주)

#### 2-1. 시가총액 보너스 점수

```python
# 시가총액 기준 (단위: 억원)
MARKET_CAP_BONUS = {
    "mega":   (100000, float('inf'), 5.0),   # 10조+ → +5점
    "large":  (30000, 100000, 3.0),           # 3조~10조 → +3점
    "mid":    (10000, 30000, 1.0),            # 1조~3조 → +1점
    "small":  (0, 10000, 0.0),                # 1조 미만 → 0점
}

def calc_market_cap_bonus(market_cap: float) -> float:
    """시가총액 보너스 점수"""
    for name, (min_cap, max_cap, bonus) in MARKET_CAP_BONUS.items():
        if min_cap <= market_cap < max_cap:
            return bonus
    return 0.0
```

**소스:**
- `nomad_candidates.market_cap` 컬럼 활용
- 없으면 네이버 금융에서 실시간 조회

#### 2-2. 대기업 전용 TOP5 표시

```
📊 종가매매 TOP5 (전체)
#1 알루코 86.9점 S등급
#2 스맥 80.3점 A등급
...

🏢 대기업 TOP5 (시총 1조+)
#1 삼성중공업 79.8점 A등급
#2 한온시스템 78.2점 A등급
...
```

### Phase 3: 순위 재정렬 (다음 주)

#### 3-1. TOP2-3 우선 표시 옵션

**배경:**
백테스트에서 TOP2-3이 TOP1보다 승률 높음

**방법 A: 순위 가중치 조정**
```python
# 점수 동점일 때 TOP2-3 우선
def adjust_rank_preference(scores: List[StockScoreV5]) -> List[StockScoreV5]:
    # 점수 차이가 2점 이내면 TOP2-3 형태 우대
    ...
```

**방법 B: "추천" 마크 추가**
```
#1 알루코 86.9점 S등급
#2 스맥 80.3점 A등급 ⭐추천
#3 삼성중공업 79.8점 A등급 ⭐추천
```

### Phase 4: 뉴스/AI 통합 (나중)

#### 4-1. 14:50 실시간 판단 시스템

```
[14:50 스케줄]
    │
    ├─ 종가매매 TOP5 스크리닝 (기존)
    │
    ├─ 거래량 TOP5 수집 (신규)
    │
    ├─ 뉴스 수집 (신규)
    │     └─ 네이버/구글 뉴스 검색
    │
    └─ 로컬 AI 판단 (DeepSeek/Ollama)
          ├─ 호재/악재 분류
          ├─ 백테스트 DB 참조
          └─ 최종 추천 점수 계산
```

**구현 순서:**
1. 뉴스 수집 자동화 (네이버 API)
2. 뉴스 감성 분석 (로컬 LLM)
3. 최종 통합 점수 시스템

---

## 📁 수정 파일 목록

| 파일 | 수정 내용 | 우선순위 |
|------|----------|----------|
| `src/domain/score_calculator.py` | CCI 하드필터, 시총 보너스 | P1 |
| `src/services/screener_service.py` | 필터링 로직 적용 | P1 |
| `src/adapters/discord_notifier.py` | 대기업 TOP5 별도 표시 | P2 |
| `dashboard/pages/1_종가매매_TOP5.py` | 시총 필터 UI | P2 |
| `src/services/news_service.py` | 14:50 뉴스 수집 | P3 |
| `src/services/ai_analyzer.py` | 로컬 AI 통합 (신규) | P4 |

---

## 🧪 테스트 케이스

### CCI 하드필터 검증

```python
# 예상 결과: 1/13~1/16 TOP5 중 CCI 250+ 종목 필터링
stocks_before = [
    ("한켐", 578, 86.9),
    ("일지테크", 542, 83.0),
    ("아센디오", 467, 81.9),
    ...
]

stocks_after = filter_by_cci(stocks_before)
# → CCI 250 미만인 종목만 남음
```

### 대기업 보너스 검증

```python
# 시가총액 10조 → +5점
# 시가총액 5조 → +3점
# 시가총액 5천억 → +0점

# 예상: 삼성중공업(시총 10조+) 기존 79.8 → 84.8점
```

---

## 📅 실행 계획

| 일정 | 작업 | 완료 기준 |
|------|------|----------|
| Day 1 | CCI 하드필터 구현 | 테스트 통과 |
| Day 2 | 시가총액 보너스 추가 | Discord 표시 확인 |
| Day 3 | 대시보드 UI 업데이트 | 스트림릿 동작 확인 |
| Week 2 | TOP2-3 우대 로직 | 백테스트 비교 |
| Week 3+ | 뉴스/AI 통합 | 파일럿 테스트 |

---

## ✅ 체크리스트

- [ ] CCI 250+ 하드 필터 추가
- [ ] CCI 점수 곡선 강화 (220+ 감점)
- [ ] 시가총액 보너스 점수 추가
- [ ] Discord 대기업 TOP5 별도 표시
- [ ] 대시보드 시가총액 필터 UI
- [ ] TOP2-3 추천 마크
- [ ] 뉴스 수집 자동화
- [ ] 로컬 AI 통합

---

*최종 수정: 2026-01-20*
